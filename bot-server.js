const express = require('express');
const { Telegraf } = require('telegraf');
const { VK } = require('vk-io'); // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç

const app = express();
app.use(express.json());

// –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç –¥–ª—è VK-Telegram
class VkTelegramBot {
    constructor() {
        this.isRunning = false;
        this.stats = {
            photosSent: 0,
            startTime: null,
            lastUpdate: null
        };
        
        try {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK API
            this.vk = new VK({
                token: process.env.VK_TOKEN
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –±–æ—Ç–æ–≤
            this.tgBot = new Telegraf(process.env.TG_TOKEN);
            this.controllerBot = new Telegraf(process.env.TG_CONTROLLER_TOKEN);
            
            console.log('–ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞:', error);
        }
    }
    
    async start() {
        if (this.isRunning) {
            console.log('–ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω');
            return;
        }
        
        try {
            console.log('–ó–∞–ø—É—Å–∫ VK-Telegram –±–æ—Ç–∞...');
            this.stats.startTime = new Date();
            this.stats.lastUpdate = new Date();
            this.isRunning = true;
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VK —Å–ª—É—à–∞—Ç–µ–ª—è
            await this.setupVKListener();
            
            // –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–æ–≤
            await this.tgBot.launch();
            await this.controllerBot.launch();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
            this.setupControllerCommands();
            
            console.log('–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:', error);
            this.isRunning = false;
            throw error;
        }
    }
    
    async setupVKListener() {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å VK API
            const groups = await this.vk.api.groups.getById({});
            console.log('VK API –ø–æ–¥–∫–ª—é—á–µ–Ω. –ì—Ä—É–ø–ø–∞:', groups);
            
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ VK
            this.startVKPolling();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ VK —Å–ª—É—à–∞—Ç–µ–ª—è:', error);
            throw error;
        }
    }
    
    startVKPolling() {
        // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø—Ä–æ—Å–∞ VK wall
        console.log('–ó–∞–ø—É—Å–∫ –æ–ø—Ä–æ—Å–∞ —Å—Ç–µ–Ω—ã VK...');
        
        // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç setInterval –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤
        setInterval(async () => {
            if (!this.isRunning) return;
            
            try {
                const posts = await this.vk.api.wall.get({
                    owner_id: -Math.abs(process.env.VK_GROUP_ID),
                    count: 5
                });
                
                console.log(`–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –ø–æ—Å—Ç–æ–≤: ${posts.items.length}`);
                this.stats.lastUpdate = new Date();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–æ—Å–µ VK:', error);
            }
        }, 60000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    }
    
    setupControllerCommands() {
        // –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –±–æ—Ç–∞-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
        this.controllerBot.command('start', (ctx) => {
            ctx.reply('ü§ñ –ë–æ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω!\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /status –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è');
        });
        
        this.controllerBot.command('status', (ctx) => {
            if (ctx.from.id.toString() === process.env.TG_ADMIN_ID) {
                const status = this.getStatus();
                ctx.reply(
                    `üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:\n` +
                    `ü§ñ –ë–æ—Ç: ${status.isRunning ? 'üü¢ –ó–∞–ø—É—â–µ–Ω' : 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}\n` +
                    `üì∏ –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${status.photosSent}\n` +
                    `‚è±Ô∏è –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: ${status.uptime}\n` +
                    `üïí –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${status.lastUpdate}`
                );
            } else {
                ctx.reply('‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã');
            }
        });
        
        this.controllerBot.command('start_bot', async (ctx) => {
            if (ctx.from.id.toString() === process.env.TG_ADMIN_ID) {
                try {
                    await this.start();
                    ctx.reply('‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω');
                } catch (error) {
                    ctx.reply('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: ' + error.message);
                }
            }
        });
        
        this.controllerBot.command('stop_bot', async (ctx) => {
            if (ctx.from.id.toString() === process.env.TG_ADMIN_ID) {
                try {
                    await this.stop();
                    ctx.reply('‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                } catch (error) {
                    ctx.reply('‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞: ' + error.message);
                }
            }
        });
        
        console.log('–ö–æ–º–∞–Ω–¥—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
    }
    
    async stop() {
        if (!this.isRunning) {
            console.log('–ë–æ—Ç —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            return;
        }
        
        try {
            console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...');
            this.isRunning = false;
            
            await this.tgBot.stop();
            await this.controllerBot.stop();
            
            console.log('–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞:', error);
            throw error;
        }
    }
    
    getStatus() {
        const uptime = this.stats.startTime ? 
            Math.floor((new Date() - this.stats.startTime) / 1000) : 0;
        
        const formatUptime = (seconds) => {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours}—á ${minutes}–º ${secs}—Å`;
        };
        
        return {
            isRunning: this.isRunning,
            photosSent: this.stats.photosSent,
            uptime: this.stats.startTime ? formatUptime(uptime) : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω',
            lastUpdate: this.stats.lastUpdate ? 
                this.stats.lastUpdate.toLocaleTimeString() : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
        };
    }
}

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
const bot = new VkTelegramBot();

// API endpoints –¥–ª—è Cloudflare Worker
app.get('/api/status', (req, res) => {
    try {
        const status = bot.getStatus();
        res.json(status);
    } catch (error) {
        res.status(500).json({ 
            success: false, 
            message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞',
            error: error.message 
        });
    }
});

app.post('/api/control', async (req, res) => {
    const { action } = req.body;
    
    try {
        switch (action) {
            case 'start':
                await bot.start();
                res.json({ success: true, message: '–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω' });
                break;
            case 'stop':
                await bot.stop();
                res.json({ success: true, message: '–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' });
                break;
            case 'restart':
                await bot.stop();
                await new Promise(resolve => setTimeout(resolve, 2000));
                await bot.start();
                res.json({ success: true, message: '–ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω' });
                break;
            default:
                res.status(400).json({ success: false, message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ' });
        }
    } catch (error) {
        res.status(500).json({ 
            success: false, 
            message: error.message 
        });
    }
});

app.get('/api/config', (req, res) => {
    try {
        const config = {
            VK_TOKEN: process.env.VK_TOKEN ? '***' + process.env.VK_TOKEN.slice(-4) : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',
            VK_GROUP_ID: process.env.VK_GROUP_ID || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',
            TG_TOKEN: process.env.TG_TOKEN ? '***' + process.env.TG_TOKEN.slice(-4) : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',
            TG_CHANNEL_ID: process.env.TG_CHANNEL_ID || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',
            TG_USER_ID: process.env.TG_USER_ID || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',
            TG_CONTROLLER_TOKEN: process.env.TG_CONTROLLER_TOKEN ? '***' + process.env.TG_CONTROLLER_TOKEN.slice(-4) : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',
            TG_ADMIN_ID: process.env.TG_ADMIN_ID || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
        };
        
        res.json(config);
    } catch (error) {
        res.status(500).json({ 
            success: false, 
            message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏',
            error: error.message 
        });
    }
});

// Health check endpoint
app.get('/health', (req, res) => {
    res.json({ 
        status: 'ok', 
        timestamp: new Date().toISOString(),
        botRunning: bot.isRunning 
    });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
app.use((error, req, res, next) => {
    console.error('Unhandled error:', error);
    res.status(500).json({ 
        success: false, 
        message: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' 
    });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`üöÄ Bot server running on port ${PORT}`);
    console.log(`üìä Health check available at http://localhost:${PORT}/health`);
});
